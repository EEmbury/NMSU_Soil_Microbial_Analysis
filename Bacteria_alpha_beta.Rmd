---
title: '<span style = ''font-size:14pt;''>**Microbial Communities in the changing vegetation of the Chihuahuan Desert 
**</span>'
subtitle: '<span style = ''font-size:12pt;''> Bacteria Alpha and Beta Diversity
</span>'
author: "Emily Embury"
date: "`r Sys.Date()`"
output: html_document
---
<style type="text/css">
/* Whole document: */ 
body{
  font-size: 12pt;
}
/* Headers */
h1{
  font-size: 12pt;
}
</style>

---

```{r include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,              
  warning = FALSE,       
  message = FALSE,  
  cache = FALSE,        
  fig.align = "center", 
  fig.height = 4,
  fig.width = 6,
  class.source="bg-warning",
  class.output="bg-success"
)

```


# **Import qiime formatted data**
  - https://blog.codyglickman.com/2018/10/qiime2-to-phyloseq.html

```{r import_data}
library(phyloseq)

biom_data_raw <- import_biom(BIOMfilename = "Bacteria/bacteria_taxa_table_raw.biom", refseqfilename = "Bacteria/bacteria-dna-sequences-rare.fasta")

mapping_file <- import_qiime_sample_data(mapfilename = "Bacteria/CORRECTED_metadata.tsv")



# Merge the OTU and mapping data into a phyloseq object
phylo_raw <- merge_phyloseq(biom_data_raw, mapping_file)
#Add names to biom table and check phyloseq objects
colnames(tax_table(phylo_raw))= c("Kingdom","Phylum","Class","Order","Family","Genus", "Species")
```
# **remove controls + contaminants**

```{r clean_data}
library(decontam)

# threshold 0.5, identifies 9 contaminants
contamdf.prev05 <- isContaminant(phylo_raw, method="prevalence", neg="neg", threshold=0.5)
table(contamdf.prev05$contaminant)

#prune the contaminated taxa
phylo_rm_contaminat <- prune_taxa(!contamdf.prev05$contaminant, phylo_raw)
phylo_rm_contaminat #after

#remove any left over controls so they dont impact normalization
phylo_rm_contaminat_rm_cntrl = subset_samples(phylo_rm_contaminat, sample.id != "CONTROL1-S1" & sample.id != "CONTROL2-S79" & sample.id != "CONTROL3-S109")

## remove unknowns and archaea, leaving only bacteria
bac <- subset_taxa(phylo_rm_contaminat_rm_cntrl, Kingdom == "d__Bacteria")
phylo_rm_contaminat_rm_cntrl<- prune_taxa(c(taxa_names(bac)), phylo_rm_contaminat_rm_cntrl)
```


# **Alpha Diversity**
  - https://joey711.github.io/phyloseq/plot_richness-examples.html
  - https://rpubs.com/lconteville/713954 


- https://doi.org/10.1016/j.resmic.2018.03.004 states that shannon is the best index to use

- "Simpsonâ€™s index (D) Estimator of species richness and species evenness: more weight on species evenness" -- https://doi.org/10.4014/jmb.1709.09027 

```{r rarefy}
rare <- rarefy_even_depth(phylo_rm_contaminat_rm_cntrl, rngseed = 9999)

```

```{r alpha_Shannon}
richness <- estimate_richness(rare)

#Shannon
anova.sh.veg = aov(richness$Shannon ~ sample_data(rare)$vegetation*sample_data(rare)$month)
summary(anova.sh.veg)

#check anova assumptions
#check anova assumptions
par(mfrow = c(1,2)) #puts the plots next to each other
qqnorm(anova.sh.veg$residuals) #normal q-q plot, tests normality
qqline(anova.sh.veg$residuals, col = "red") #line of fit on q-q plot
plot(anova.sh.veg$fitted.values, anova.sh.veg$residuals, main = "Residuals vs Fitted", xlab = "Fitted Values", 
     ylab = "Residuals") #residuals vs. fitted, test variance
abline(h=0, col = "red") 

tukey.sh <- TukeyHSD(anova.sh.veg)

alpha_veg_sh <- plot_richness(rare, x = "vegetation", measures = c("Shannon"))
alpha_veg_sh

alpha_mo_sh <- plot_richness(rare, x = "month", measures = c("Shannon"))
alpha_mo_sh

```



# **Beta Diversity**

- http://evomics.org/wp-content/uploads/2016/01/phyloseq-Lab-01-Answers.html
- https://www.youtube.com/watch?v=oLf0EpMJ4yA 

- adonis = essentially an ANOVA for distances
- betadisper = testing for significant different variation


- "Furthermore, beta-diversity measures might be chosen to make it easier to assess a specific hypothesis, such as changes in microbiome composition over time. For example, a Bray Curtis distance that uses all the abundance differences may be more sensitive to examine gradients of diversity with location or time" -- https://doi.org/10.1016/j.csbj.2022.04.032 

-  https://doi.org/10.1111/2041-210X.13115 = proportions and rarefy are the best way to normalize for BC distance in community analyses
```{r rarefy_data}

library(vegan)
library(ggplot2)
library(phyloseq)
library(tidyverse)
library(agricolae)
library(rcompanion)

rare <- rarefy_even_depth(phylo_rm_contaminat_rm_cntrl, rngseed = 9999)

```
  
```{r bray_dist_and_plot}
# calculate Bray-Curtis distance using the vegan package
DistBC <- distance(rare, method = "bray")

#ordinate bray distances
ordBC <- ordinate(rare, method = "NMDS", distance = DistBC)


#plot distances
plot_ordination(rare, ordBC, color = "vegetation") + 
  geom_point(size = 3, aes(shape = month)) +
  ggtitle("NMDS: Bray-Curtis")+
  stat_ellipse()+
  scale_color_manual(values=c("Mesquite" ="#c1292e", "Mesquite_grass" = "#e1bc29", "Grass" = "#679436", name = "vegetation"))


```

```{r beta_statistics}
#### Statistics ####

#create data frame of metadata
sampleDF <-  data.frame(sample_data(rare))

# adonis : Analysis of variance using distance matrices
adonis2(DistBC ~ sampleDF$vegetation*sampleDF$month, data = sampleDF)

#### significance of vegetation ####
library(pairwiseAdonis)
pairwise.adonis(DistBC, phyloseq::sample_data(rare)$vegetation)

# betadisper - analysis of multivariate homogeneity of group dispersion (variances)
beta <- betadisper(DistBC, sampleDF$vegetation)
anova(beta)
permutest(beta)
plot(beta)

#### significance of vegetation*month ####
library(pairwiseAdonis)
pairwise_adon <- pairwise.adonis(DistBC, phyloseq::sample_data(rare)$month_veg)

library(dplyr)
### filter pairwise results to only show significant values
pa <- pairwise_adon %>%
  filter(`p.adjusted` < .05) 

if(nrow(pa) == 0){
    print("data.frame is empty, no significant values")
}else{
    print("data.frame contains data")
}

# betadisper - analysis of multivariate homogeneity of group dispersion (variances)
beta <- betadisper(DistBC, sampleDF$month_veg)
anova(beta)
permutest(beta)

```

```{r session_info}
library(devtools)
session_info()
```